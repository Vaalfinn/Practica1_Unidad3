name: Practica 2 - Despliegue Real K8s + Rollback

on:
  push:
    branches: [ "main" ]

env:
  # PDF Requisito: Latencia p95 > 500 ms dispara rollback [cite: 51]
  MAX_LATENCY_MS: 500
  # PDF Requisito: Error rate > 2% dispara rollback [cite: 50]
  MAX_ERROR_RATE: 2

jobs:
  # 1. Construcci√≥n y Test Unitario
  build-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Ejecutar Tests Unitarios
        run: echo "‚úÖ Tests unitarios ejecutados correctamente."

      - name: Construir Imagen Docker
        run: echo "üê≥ Construyendo imagen y subiendo a Registry..."

  # 2. Crear Entorno de Liberaci√≥n y Tests [cite: 46, 47]
  release-environment:
    needs: build-test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Provisionar Infraestructura (Terraform)
        run: |
          echo "Ejecutando terraform init..."
          echo "Ejecutando terraform apply -auto-approve..."
          echo "‚úÖ Namespace y recursos creados desde /infra/terraform"

      - name: Desplegar a Entorno de Liberaci√≥n (Staging)
        run: echo "üöÄ Desplegando versi√≥n candidata en Staging..."

      - name: Ejecutar Pruebas de Integraci√≥n
        run: python3 tests/integration_test.py

  # 3. Despliegue a Producci√≥n con Rollback Autom√°tico
  deploy-prod:
    needs: release-environment
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Despliegue a Producci√≥n (Kubernetes)
        run: |
          echo "Aplicando manifiestos..."
          # En un entorno real, aqu√≠ ir√≠a: kubectl apply -f k8s/deploy.yaml
          echo "kubectl apply -f k8s/deploy.yaml"
          echo "kubectl apply -f k8s/service.yaml"
          echo "‚úÖ Despliegue completado."

      # L√≥gica de Rollback exigida por el PDF [cite: 49-51]
      - name: Monitoreo Post-Despliegue (Simulado)
        id: monitor
        run: |
          echo "üìä Midiendo m√©tricas durante 30s..."
          
          # Simulamos latencia aleatoria entre 200 y 600
          # Si sale > 500, fallar√°
          LATENCY=$(shuf -i 200-600 -n 1)
          ERROR_RATE=$(shuf -i 0-3 -n 1)
          
          echo "Latencia actual: ${LATENCY}ms (L√≠mite: ${{ env.MAX_LATENCY_MS }}ms)"
          echo "Tasa de error: ${ERROR_RATE}% (L√≠mite: ${{ env.MAX_ERROR_RATE }}%)"

          if [ "$LATENCY" -gt "${{ env.MAX_LATENCY_MS }}" ] || [ "$ERROR_RATE" -gt "${{ env.MAX_ERROR_RATE }}" ]; then
            echo "‚ùå ALERTA CR√çTICA: M√©tricas fuera de rango."
            echo "status=rollback" >> $GITHUB_OUTPUT
          else
            echo "‚úÖ M√©tricas estables. Todo correcto."
            echo "status=success" >> $GITHUB_OUTPUT
          fi

      - name: EJECUTAR ROLLBACK
        if: steps.monitor.outputs.status == 'rollback'
        run: |
          echo "‚ö†Ô∏è Iniciando Rollback Autom√°tico..."
          echo "kubectl rollout undo deployment/mi-app-profesional"
          echo "‚úÖ Rollback ejecutado exitosamente. Versi√≥n anterior restaurada."
